"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[248],{3905:function(a,e,m){m.r(e),m.d(e,{MDXContext:function(){return l},MDXProvider:function(){return N},mdx:function(){return h},useMDXComponents:function(){return d},withMDXComponents:function(){return o}});var s=m(67294);function n(a,e,m){return e in a?Object.defineProperty(a,e,{value:m,enumerable:!0,configurable:!0,writable:!0}):a[e]=m,a}function t(){return t=Object.assign||function(a){for(var e=1;e<arguments.length;e++){var m=arguments[e];for(var s in m)Object.prototype.hasOwnProperty.call(m,s)&&(a[s]=m[s])}return a},t.apply(this,arguments)}function p(a,e){var m=Object.keys(a);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(a);e&&(s=s.filter((function(e){return Object.getOwnPropertyDescriptor(a,e).enumerable}))),m.push.apply(m,s)}return m}function r(a){for(var e=1;e<arguments.length;e++){var m=null!=arguments[e]?arguments[e]:{};e%2?p(Object(m),!0).forEach((function(e){n(a,e,m[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(m)):p(Object(m)).forEach((function(e){Object.defineProperty(a,e,Object.getOwnPropertyDescriptor(m,e))}))}return a}function i(a,e){if(null==a)return{};var m,s,n=function(a,e){if(null==a)return{};var m,s,n={},t=Object.keys(a);for(s=0;s<t.length;s++)m=t[s],e.indexOf(m)>=0||(n[m]=a[m]);return n}(a,e);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(a);for(s=0;s<t.length;s++)m=t[s],e.indexOf(m)>=0||Object.prototype.propertyIsEnumerable.call(a,m)&&(n[m]=a[m])}return n}var l=s.createContext({}),o=function(a){return function(e){var m=d(e.components);return s.createElement(a,t({},e,{components:m}))}},d=function(a){var e=s.useContext(l),m=e;return a&&(m="function"==typeof a?a(e):r(r({},e),a)),m},N=function(a){var e=d(a.components);return s.createElement(l.Provider,{value:e},a.children)},c={inlineCode:"code",wrapper:function(a){var e=a.children;return s.createElement(s.Fragment,{},e)}},x=s.forwardRef((function(a,e){var m=a.components,n=a.mdxType,t=a.originalType,p=a.parentName,l=i(a,["components","mdxType","originalType","parentName"]),o=d(m),N=n,x=o["".concat(p,".").concat(N)]||o[N]||c[N]||t;return m?s.createElement(x,r(r({ref:e},l),{},{components:m})):s.createElement(x,r({ref:e},l))}));function h(a,e){var m=arguments,n=e&&e.mdxType;if("string"==typeof a||n){var t=m.length,p=new Array(t);p[0]=x;var r={};for(var i in e)hasOwnProperty.call(e,i)&&(r[i]=e[i]);r.originalType=a,r.mdxType="string"==typeof a?a:n,p[1]=r;for(var l=2;l<t;l++)p[l]=m[l];return s.createElement.apply(null,p)}return s.createElement.apply(null,m)}x.displayName="MDXCreateElement"},80371:function(a,e,m){m.r(e),m.d(e,{frontMatter:function(){return r},contentTitle:function(){return i},metadata:function(){return l},toc:function(){return o},default:function(){return N}});var s=m(87462),n=m(63366),t=(m(67294),m(3905)),p=["components"],r={},i=void 0,l={unversionedId:"framework_topics/custom_proposers/custom_proposers",id:"framework_topics/custom_proposers/custom_proposers",isDocsHomePage:!1,title:"custom_proposers",description:"Custom Proposers",source:"@site/../docs/framework_topics/custom_proposers/custom_proposers.md",sourceDirName:"framework_topics/custom_proposers",slug:"/framework_topics/custom_proposers/custom_proposers",permalink:"/docs/framework_topics/custom_proposers/custom_proposers",editUrl:"https://github.com/facebook/docusaurus/edit/master/website/../docs/framework_topics/custom_proposers/custom_proposers.md",tags:[],version:"current",frontMatter:{},sidebar:"someSidebar",previous:{title:"inference",permalink:"/docs/framework_topics/inference/inference"},next:{title:"variable",permalink:"/docs/framework_topics/custom_proposers/variable"}},o=[{value:"Custom Proposers",id:"custom-proposers",children:[{value:"Propose",id:"propose",children:[],level:4},{value:"Post Process",id:"post-process",children:[],level:4},{value:"Important Methods",id:"important-methods",children:[],level:3},{value:"Sample Custom Proposer",id:"sample-custom-proposer",children:[],level:3},{value:"Gradient-based proposers",id:"gradient-based-proposers",children:[],level:3}],level:2}],d={toc:o};function N(a){var e=a.components,m=(0,n.Z)(a,p);return(0,t.mdx)("wrapper",(0,s.Z)({},d,m,{components:e,mdxType:"MDXLayout"}),(0,t.mdx)("h2",{id:"custom-proposers"},"Custom Proposers"),(0,t.mdx)("p",null,"Bean Machine is flexible and easily allows users to supply custom Metropolis Hastings proposers for specific random variables. This enables users to easily incorporate domain knowledge to inference."),(0,t.mdx)("p",null,"For each iteration of sampling of variable ",(0,t.mdx)("span",{parentName:"p",className:"math math-inline"},(0,t.mdx)("span",{parentName:"span",className:"katex"},(0,t.mdx)("span",{parentName:"span",className:"katex-mathml"},(0,t.mdx)("math",{parentName:"span",xmlns:"http://www.w3.org/1998/Math/MathML"},(0,t.mdx)("semantics",{parentName:"math"},(0,t.mdx)("mrow",{parentName:"semantics"},(0,t.mdx)("mi",{parentName:"mrow"},"X")),(0,t.mdx)("annotation",{parentName:"semantics",encoding:"application/x-tex"},"X")))),(0,t.mdx)("span",{parentName:"span",className:"katex-html","aria-hidden":"true"},(0,t.mdx)("span",{parentName:"span",className:"base"},(0,t.mdx)("span",{parentName:"span",className:"strut",style:{height:"0.68333em",verticalAlign:"0em"}}),(0,t.mdx)("span",{parentName:"span",className:"mord mathnormal",style:{marginRight:"0.07847em"}},"X")))))," with value ",(0,t.mdx)("span",{parentName:"p",className:"math math-inline"},(0,t.mdx)("span",{parentName:"span",className:"katex"},(0,t.mdx)("span",{parentName:"span",className:"katex-mathml"},(0,t.mdx)("math",{parentName:"span",xmlns:"http://www.w3.org/1998/Math/MathML"},(0,t.mdx)("semantics",{parentName:"math"},(0,t.mdx)("mrow",{parentName:"semantics"},(0,t.mdx)("mi",{parentName:"mrow"},"x")),(0,t.mdx)("annotation",{parentName:"semantics",encoding:"application/x-tex"},"x")))),(0,t.mdx)("span",{parentName:"span",className:"katex-html","aria-hidden":"true"},(0,t.mdx)("span",{parentName:"span",className:"base"},(0,t.mdx)("span",{parentName:"span",className:"strut",style:{height:"0.43056em",verticalAlign:"0em"}}),(0,t.mdx)("span",{parentName:"span",className:"mord mathnormal"},"x")))))," using the Metropolis Hastings algorithm, we first sample a new value ",(0,t.mdx)("span",{parentName:"p",className:"math math-inline"},(0,t.mdx)("span",{parentName:"span",className:"katex"},(0,t.mdx)("span",{parentName:"span",className:"katex-mathml"},(0,t.mdx)("math",{parentName:"span",xmlns:"http://www.w3.org/1998/Math/MathML"},(0,t.mdx)("semantics",{parentName:"math"},(0,t.mdx)("mrow",{parentName:"semantics"},(0,t.mdx)("msup",{parentName:"mrow"},(0,t.mdx)("mi",{parentName:"msup"},"x"),(0,t.mdx)("mo",{parentName:"msup",mathvariant:"normal",lspace:"0em",rspace:"0em"},"\u2032"))),(0,t.mdx)("annotation",{parentName:"semantics",encoding:"application/x-tex"},"x'")))),(0,t.mdx)("span",{parentName:"span",className:"katex-html","aria-hidden":"true"},(0,t.mdx)("span",{parentName:"span",className:"base"},(0,t.mdx)("span",{parentName:"span",className:"strut",style:{height:"0.751892em",verticalAlign:"0em"}}),(0,t.mdx)("span",{parentName:"span",className:"mord"},(0,t.mdx)("span",{parentName:"span",className:"mord mathnormal"},"x"),(0,t.mdx)("span",{parentName:"span",className:"msupsub"},(0,t.mdx)("span",{parentName:"span",className:"vlist-t"},(0,t.mdx)("span",{parentName:"span",className:"vlist-r"},(0,t.mdx)("span",{parentName:"span",className:"vlist",style:{height:"0.751892em"}},(0,t.mdx)("span",{parentName:"span",style:{top:"-3.063em",marginRight:"0.05em"}},(0,t.mdx)("span",{parentName:"span",className:"pstrut",style:{height:"2.7em"}}),(0,t.mdx)("span",{parentName:"span",className:"sizing reset-size6 size3 mtight"},(0,t.mdx)("span",{parentName:"span",className:"mord mtight"},(0,t.mdx)("span",{parentName:"span",className:"mord mtight"},"\u2032")))))))))))))," for ",(0,t.mdx)("span",{parentName:"p",className:"math math-inline"},(0,t.mdx)("span",{parentName:"span",className:"katex"},(0,t.mdx)("span",{parentName:"span",className:"katex-mathml"},(0,t.mdx)("math",{parentName:"span",xmlns:"http://www.w3.org/1998/Math/MathML"},(0,t.mdx)("semantics",{parentName:"math"},(0,t.mdx)("mrow",{parentName:"semantics"},(0,t.mdx)("mi",{parentName:"mrow"},"X")),(0,t.mdx)("annotation",{parentName:"semantics",encoding:"application/x-tex"},"X")))),(0,t.mdx)("span",{parentName:"span",className:"katex-html","aria-hidden":"true"},(0,t.mdx)("span",{parentName:"span",className:"base"},(0,t.mdx)("span",{parentName:"span",className:"strut",style:{height:"0.68333em",verticalAlign:"0em"}}),(0,t.mdx)("span",{parentName:"span",className:"mord mathnormal",style:{marginRight:"0.07847em"}},"X")))))," using proposal distribution ",(0,t.mdx)("span",{parentName:"p",className:"math math-inline"},(0,t.mdx)("span",{parentName:"span",className:"katex"},(0,t.mdx)("span",{parentName:"span",className:"katex-mathml"},(0,t.mdx)("math",{parentName:"span",xmlns:"http://www.w3.org/1998/Math/MathML"},(0,t.mdx)("semantics",{parentName:"math"},(0,t.mdx)("mrow",{parentName:"semantics"},(0,t.mdx)("mi",{parentName:"mrow"},"g")),(0,t.mdx)("annotation",{parentName:"semantics",encoding:"application/x-tex"},"g")))),(0,t.mdx)("span",{parentName:"span",className:"katex-html","aria-hidden":"true"},(0,t.mdx)("span",{parentName:"span",className:"base"},(0,t.mdx)("span",{parentName:"span",className:"strut",style:{height:"0.625em",verticalAlign:"-0.19444em"}}),(0,t.mdx)("span",{parentName:"span",className:"mord mathnormal",style:{marginRight:"0.03588em"}},"g"))))),". We then update the world to reflect this change, and use the Metropolis Hastings ratio of\n",(0,t.mdx)("span",{parentName:"p",className:"math math-inline"},(0,t.mdx)("span",{parentName:"span",className:"katex"},(0,t.mdx)("span",{parentName:"span",className:"katex-mathml"},(0,t.mdx)("math",{parentName:"span",xmlns:"http://www.w3.org/1998/Math/MathML"},(0,t.mdx)("semantics",{parentName:"math"},(0,t.mdx)("mrow",{parentName:"semantics"},(0,t.mdx)("mtext",{parentName:"mrow"},"min"),(0,t.mdx)("mo",{parentName:"mrow",fence:"false"},"["),(0,t.mdx)("mn",{parentName:"mrow"},"1"),(0,t.mdx)("mo",{parentName:"mrow",separator:"true"},","),(0,t.mdx)("mfrac",{parentName:"mrow"},(0,t.mdx)("mrow",{parentName:"mfrac"},(0,t.mdx)("mi",{parentName:"mrow"},"p"),(0,t.mdx)("mo",{parentName:"mrow",stretchy:"false"},"("),(0,t.mdx)("msup",{parentName:"mrow"},(0,t.mdx)("mi",{parentName:"msup"},"x"),(0,t.mdx)("mo",{parentName:"msup",mathvariant:"normal",lspace:"0em",rspace:"0em"},"\u2032")),(0,t.mdx)("mo",{parentName:"mrow",stretchy:"false"},")"),(0,t.mdx)("mi",{parentName:"mrow"},"g"),(0,t.mdx)("mo",{parentName:"mrow",stretchy:"false"},"("),(0,t.mdx)("mi",{parentName:"mrow"},"x"),(0,t.mdx)("mo",{parentName:"mrow"},"\u2223"),(0,t.mdx)("msup",{parentName:"mrow"},(0,t.mdx)("mi",{parentName:"msup"},"x"),(0,t.mdx)("mo",{parentName:"msup",mathvariant:"normal",lspace:"0em",rspace:"0em"},"\u2032")),(0,t.mdx)("mo",{parentName:"mrow",stretchy:"false"},")")),(0,t.mdx)("mrow",{parentName:"mfrac"},(0,t.mdx)("mi",{parentName:"mrow"},"p"),(0,t.mdx)("mo",{parentName:"mrow",stretchy:"false"},"("),(0,t.mdx)("mi",{parentName:"mrow"},"x"),(0,t.mdx)("mo",{parentName:"mrow",stretchy:"false"},")"),(0,t.mdx)("mi",{parentName:"mrow"},"g"),(0,t.mdx)("mo",{parentName:"mrow",stretchy:"false"},"("),(0,t.mdx)("msup",{parentName:"mrow"},(0,t.mdx)("mi",{parentName:"msup"},"x"),(0,t.mdx)("mo",{parentName:"msup",mathvariant:"normal",lspace:"0em",rspace:"0em"},"\u2032")),(0,t.mdx)("mo",{parentName:"mrow"},"\u2223"),(0,t.mdx)("mi",{parentName:"mrow"},"x"),(0,t.mdx)("mo",{parentName:"mrow",stretchy:"false"},")"))),(0,t.mdx)("mo",{parentName:"mrow",fence:"false"},"]")),(0,t.mdx)("annotation",{parentName:"semantics",encoding:"application/x-tex"},"\\text{min}\\big[1, \\frac{p(x')g(x \\mid x')}{p(x)g(x' \\mid x)}\\big]")))),(0,t.mdx)("span",{parentName:"span",className:"katex-html","aria-hidden":"true"},(0,t.mdx)("span",{parentName:"span",className:"base"},(0,t.mdx)("span",{parentName:"span",className:"strut",style:{height:"1.58448em",verticalAlign:"-0.52em"}}),(0,t.mdx)("span",{parentName:"span",className:"mord text"},(0,t.mdx)("span",{parentName:"span",className:"mord"},"min")),(0,t.mdx)("span",{parentName:"span",className:"mord"},(0,t.mdx)("span",{parentName:"span",className:"delimsizing size1"},"[")),(0,t.mdx)("span",{parentName:"span",className:"mord"},"1"),(0,t.mdx)("span",{parentName:"span",className:"mpunct"},","),(0,t.mdx)("span",{parentName:"span",className:"mspace",style:{marginRight:"0.16666666666666666em"}}),(0,t.mdx)("span",{parentName:"span",className:"mord"},(0,t.mdx)("span",{parentName:"span",className:"mopen nulldelimiter"}),(0,t.mdx)("span",{parentName:"span",className:"mfrac"},(0,t.mdx)("span",{parentName:"span",className:"vlist-t vlist-t2"},(0,t.mdx)("span",{parentName:"span",className:"vlist-r"},(0,t.mdx)("span",{parentName:"span",className:"vlist",style:{height:"1.06448em"}},(0,t.mdx)("span",{parentName:"span",style:{top:"-2.655em"}},(0,t.mdx)("span",{parentName:"span",className:"pstrut",style:{height:"3em"}}),(0,t.mdx)("span",{parentName:"span",className:"sizing reset-size6 size3 mtight"},(0,t.mdx)("span",{parentName:"span",className:"mord mtight"},(0,t.mdx)("span",{parentName:"span",className:"mord mathnormal mtight"},"p"),(0,t.mdx)("span",{parentName:"span",className:"mopen mtight"},"("),(0,t.mdx)("span",{parentName:"span",className:"mord mathnormal mtight"},"x"),(0,t.mdx)("span",{parentName:"span",className:"mclose mtight"},")"),(0,t.mdx)("span",{parentName:"span",className:"mord mathnormal mtight",style:{marginRight:"0.03588em"}},"g"),(0,t.mdx)("span",{parentName:"span",className:"mopen mtight"},"("),(0,t.mdx)("span",{parentName:"span",className:"mord mtight"},(0,t.mdx)("span",{parentName:"span",className:"mord mathnormal mtight"},"x"),(0,t.mdx)("span",{parentName:"span",className:"msupsub"},(0,t.mdx)("span",{parentName:"span",className:"vlist-t"},(0,t.mdx)("span",{parentName:"span",className:"vlist-r"},(0,t.mdx)("span",{parentName:"span",className:"vlist",style:{height:"0.6828285714285715em"}},(0,t.mdx)("span",{parentName:"span",style:{top:"-2.786em",marginRight:"0.07142857142857144em"}},(0,t.mdx)("span",{parentName:"span",className:"pstrut",style:{height:"2.5em"}}),(0,t.mdx)("span",{parentName:"span",className:"sizing reset-size3 size1 mtight"},(0,t.mdx)("span",{parentName:"span",className:"mord mtight"},(0,t.mdx)("span",{parentName:"span",className:"mord mtight"},"\u2032"))))))))),(0,t.mdx)("span",{parentName:"span",className:"mrel mtight"},"\u2223"),(0,t.mdx)("span",{parentName:"span",className:"mord mathnormal mtight"},"x"),(0,t.mdx)("span",{parentName:"span",className:"mclose mtight"},")")))),(0,t.mdx)("span",{parentName:"span",style:{top:"-3.23em"}},(0,t.mdx)("span",{parentName:"span",className:"pstrut",style:{height:"3em"}}),(0,t.mdx)("span",{parentName:"span",className:"frac-line",style:{borderBottomWidth:"0.04em"}})),(0,t.mdx)("span",{parentName:"span",style:{top:"-3.485em"}},(0,t.mdx)("span",{parentName:"span",className:"pstrut",style:{height:"3em"}}),(0,t.mdx)("span",{parentName:"span",className:"sizing reset-size6 size3 mtight"},(0,t.mdx)("span",{parentName:"span",className:"mord mtight"},(0,t.mdx)("span",{parentName:"span",className:"mord mathnormal mtight"},"p"),(0,t.mdx)("span",{parentName:"span",className:"mopen mtight"},"("),(0,t.mdx)("span",{parentName:"span",className:"mord mtight"},(0,t.mdx)("span",{parentName:"span",className:"mord mathnormal mtight"},"x"),(0,t.mdx)("span",{parentName:"span",className:"msupsub"},(0,t.mdx)("span",{parentName:"span",className:"vlist-t"},(0,t.mdx)("span",{parentName:"span",className:"vlist-r"},(0,t.mdx)("span",{parentName:"span",className:"vlist",style:{height:"0.8278285714285715em"}},(0,t.mdx)("span",{parentName:"span",style:{top:"-2.931em",marginRight:"0.07142857142857144em"}},(0,t.mdx)("span",{parentName:"span",className:"pstrut",style:{height:"2.5em"}}),(0,t.mdx)("span",{parentName:"span",className:"sizing reset-size3 size1 mtight"},(0,t.mdx)("span",{parentName:"span",className:"mord mtight"},(0,t.mdx)("span",{parentName:"span",className:"mord mtight"},"\u2032"))))))))),(0,t.mdx)("span",{parentName:"span",className:"mclose mtight"},")"),(0,t.mdx)("span",{parentName:"span",className:"mord mathnormal mtight",style:{marginRight:"0.03588em"}},"g"),(0,t.mdx)("span",{parentName:"span",className:"mopen mtight"},"("),(0,t.mdx)("span",{parentName:"span",className:"mord mathnormal mtight"},"x"),(0,t.mdx)("span",{parentName:"span",className:"mrel mtight"},"\u2223"),(0,t.mdx)("span",{parentName:"span",className:"mord mtight"},(0,t.mdx)("span",{parentName:"span",className:"mord mathnormal mtight"},"x"),(0,t.mdx)("span",{parentName:"span",className:"msupsub"},(0,t.mdx)("span",{parentName:"span",className:"vlist-t"},(0,t.mdx)("span",{parentName:"span",className:"vlist-r"},(0,t.mdx)("span",{parentName:"span",className:"vlist",style:{height:"0.8278285714285715em"}},(0,t.mdx)("span",{parentName:"span",style:{top:"-2.931em",marginRight:"0.07142857142857144em"}},(0,t.mdx)("span",{parentName:"span",className:"pstrut",style:{height:"2.5em"}}),(0,t.mdx)("span",{parentName:"span",className:"sizing reset-size3 size1 mtight"},(0,t.mdx)("span",{parentName:"span",className:"mord mtight"},(0,t.mdx)("span",{parentName:"span",className:"mord mtight"},"\u2032"))))))))),(0,t.mdx)("span",{parentName:"span",className:"mclose mtight"},")"))))),(0,t.mdx)("span",{parentName:"span",className:"vlist-s"},"\u200b")),(0,t.mdx)("span",{parentName:"span",className:"vlist-r"},(0,t.mdx)("span",{parentName:"span",className:"vlist",style:{height:"0.52em"}},(0,t.mdx)("span",{parentName:"span"}))))),(0,t.mdx)("span",{parentName:"span",className:"mclose nulldelimiter"})),(0,t.mdx)("span",{parentName:"span",className:"mord"},(0,t.mdx)("span",{parentName:"span",className:"delimsizing size1"},"]")))))),"\nto decide whether to keep the update or to revert to the world as it was before it."),(0,t.mdx)("p",null,"Bean Machine allows users to easily provide custom proposals for ",(0,t.mdx)("span",{parentName:"p",className:"math math-inline"},(0,t.mdx)("span",{parentName:"span",className:"katex"},(0,t.mdx)("span",{parentName:"span",className:"katex-mathml"},(0,t.mdx)("math",{parentName:"span",xmlns:"http://www.w3.org/1998/Math/MathML"},(0,t.mdx)("semantics",{parentName:"math"},(0,t.mdx)("mrow",{parentName:"semantics"},(0,t.mdx)("mi",{parentName:"mrow"},"g")),(0,t.mdx)("annotation",{parentName:"semantics",encoding:"application/x-tex"},"g")))),(0,t.mdx)("span",{parentName:"span",className:"katex-html","aria-hidden":"true"},(0,t.mdx)("span",{parentName:"span",className:"base"},(0,t.mdx)("span",{parentName:"span",className:"strut",style:{height:"0.625em",verticalAlign:"-0.19444em"}}),(0,t.mdx)("span",{parentName:"span",className:"mord mathnormal",style:{marginRight:"0.03588em"}},"g"))))),", without needing to implement other details such as the calculations for ",(0,t.mdx)("span",{parentName:"p",className:"math math-inline"},(0,t.mdx)("span",{parentName:"span",className:"katex"},(0,t.mdx)("span",{parentName:"span",className:"katex-mathml"},(0,t.mdx)("math",{parentName:"span",xmlns:"http://www.w3.org/1998/Math/MathML"},(0,t.mdx)("semantics",{parentName:"math"},(0,t.mdx)("mrow",{parentName:"semantics"},(0,t.mdx)("mi",{parentName:"mrow"},"p"),(0,t.mdx)("mo",{parentName:"mrow",stretchy:"false"},"("),(0,t.mdx)("msup",{parentName:"mrow"},(0,t.mdx)("mi",{parentName:"msup"},"x"),(0,t.mdx)("mo",{parentName:"msup",mathvariant:"normal",lspace:"0em",rspace:"0em"},"\u2032")),(0,t.mdx)("mo",{parentName:"mrow",stretchy:"false"},")")),(0,t.mdx)("annotation",{parentName:"semantics",encoding:"application/x-tex"},"p(x')")))),(0,t.mdx)("span",{parentName:"span",className:"katex-html","aria-hidden":"true"},(0,t.mdx)("span",{parentName:"span",className:"base"},(0,t.mdx)("span",{parentName:"span",className:"strut",style:{height:"1.001892em",verticalAlign:"-0.25em"}}),(0,t.mdx)("span",{parentName:"span",className:"mord mathnormal"},"p"),(0,t.mdx)("span",{parentName:"span",className:"mopen"},"("),(0,t.mdx)("span",{parentName:"span",className:"mord"},(0,t.mdx)("span",{parentName:"span",className:"mord mathnormal"},"x"),(0,t.mdx)("span",{parentName:"span",className:"msupsub"},(0,t.mdx)("span",{parentName:"span",className:"vlist-t"},(0,t.mdx)("span",{parentName:"span",className:"vlist-r"},(0,t.mdx)("span",{parentName:"span",className:"vlist",style:{height:"0.751892em"}},(0,t.mdx)("span",{parentName:"span",style:{top:"-3.063em",marginRight:"0.05em"}},(0,t.mdx)("span",{parentName:"span",className:"pstrut",style:{height:"2.7em"}}),(0,t.mdx)("span",{parentName:"span",className:"sizing reset-size6 size3 mtight"},(0,t.mdx)("span",{parentName:"span",className:"mord mtight"},(0,t.mdx)("span",{parentName:"span",className:"mord mtight"},"\u2032"))))))))),(0,t.mdx)("span",{parentName:"span",className:"mclose"},")")))))," or the acceptance ratio. All proposers must inherit from the ",(0,t.mdx)("inlineCode",{parentName:"p"},"AbstractSingleSiteProposer")," class and implement the following methods:"),(0,t.mdx)("pre",null,(0,t.mdx)("code",{parentName:"pre",className:"language-py"},"def propose(self, node: RVIdentifier, world: World) -> Tuple[Tensor, Tensor, Dict]:\n")),(0,t.mdx)("pre",null,(0,t.mdx)("code",{parentName:"pre",className:"language-py"},"def post_process(\n    self, node: RVIdentifier, world: World, auxiliary_variables: Dict\n) -> Tensor:\n")),(0,t.mdx)("h4",{id:"propose"},"Propose"),(0,t.mdx)("p",null,(0,t.mdx)("inlineCode",{parentName:"p"},"propose")," takes two parameters: the node and the world."),(0,t.mdx)("ul",null,(0,t.mdx)("li",{parentName:"ul"},"node: ",(0,t.mdx)("span",{parentName:"li",className:"math math-inline"},(0,t.mdx)("span",{parentName:"span",className:"katex"},(0,t.mdx)("span",{parentName:"span",className:"katex-mathml"},(0,t.mdx)("math",{parentName:"span",xmlns:"http://www.w3.org/1998/Math/MathML"},(0,t.mdx)("semantics",{parentName:"math"},(0,t.mdx)("mrow",{parentName:"semantics"},(0,t.mdx)("mi",{parentName:"mrow"},"X")),(0,t.mdx)("annotation",{parentName:"semantics",encoding:"application/x-tex"},"X")))),(0,t.mdx)("span",{parentName:"span",className:"katex-html","aria-hidden":"true"},(0,t.mdx)("span",{parentName:"span",className:"base"},(0,t.mdx)("span",{parentName:"span",className:"strut",style:{height:"0.68333em",verticalAlign:"0em"}}),(0,t.mdx)("span",{parentName:"span",className:"mord mathnormal",style:{marginRight:"0.07847em"}},"X"))))),", the random variable to propose a new value for"),(0,t.mdx)("li",{parentName:"ul"},"world: graphical data structure representing variable dependencies and values in the model ",(0,t.mdx)("em",{parentName:"li"},"before")," the proposal is made")),(0,t.mdx)("p",null,"The return value of ",(0,t.mdx)("inlineCode",{parentName:"p"},"propose")," is a tuple with three values"),(0,t.mdx)("ul",null,(0,t.mdx)("li",{parentName:"ul"},(0,t.mdx)("span",{parentName:"li",className:"math math-inline"},(0,t.mdx)("span",{parentName:"span",className:"katex"},(0,t.mdx)("span",{parentName:"span",className:"katex-mathml"},(0,t.mdx)("math",{parentName:"span",xmlns:"http://www.w3.org/1998/Math/MathML"},(0,t.mdx)("semantics",{parentName:"math"},(0,t.mdx)("mrow",{parentName:"semantics"},(0,t.mdx)("msup",{parentName:"mrow"},(0,t.mdx)("mi",{parentName:"msup"},"x"),(0,t.mdx)("mo",{parentName:"msup",mathvariant:"normal",lspace:"0em",rspace:"0em"},"\u2032"))),(0,t.mdx)("annotation",{parentName:"semantics",encoding:"application/x-tex"},"x'")))),(0,t.mdx)("span",{parentName:"span",className:"katex-html","aria-hidden":"true"},(0,t.mdx)("span",{parentName:"span",className:"base"},(0,t.mdx)("span",{parentName:"span",className:"strut",style:{height:"0.751892em",verticalAlign:"0em"}}),(0,t.mdx)("span",{parentName:"span",className:"mord"},(0,t.mdx)("span",{parentName:"span",className:"mord mathnormal"},"x"),(0,t.mdx)("span",{parentName:"span",className:"msupsub"},(0,t.mdx)("span",{parentName:"span",className:"vlist-t"},(0,t.mdx)("span",{parentName:"span",className:"vlist-r"},(0,t.mdx)("span",{parentName:"span",className:"vlist",style:{height:"0.751892em"}},(0,t.mdx)("span",{parentName:"span",style:{top:"-3.063em",marginRight:"0.05em"}},(0,t.mdx)("span",{parentName:"span",className:"pstrut",style:{height:"2.7em"}}),(0,t.mdx)("span",{parentName:"span",className:"sizing reset-size6 size3 mtight"},(0,t.mdx)("span",{parentName:"span",className:"mord mtight"},(0,t.mdx)("span",{parentName:"span",className:"mord mtight"},"\u2032"))))))))))))),", the new proposed value for the node"),(0,t.mdx)("li",{parentName:"ul"},(0,t.mdx)("span",{parentName:"li",className:"math math-inline"},(0,t.mdx)("span",{parentName:"span",className:"katex"},(0,t.mdx)("span",{parentName:"span",className:"katex-mathml"},(0,t.mdx)("math",{parentName:"span",xmlns:"http://www.w3.org/1998/Math/MathML"},(0,t.mdx)("semantics",{parentName:"math"},(0,t.mdx)("mrow",{parentName:"semantics"},(0,t.mdx)("mi",{parentName:"mrow"},"log"),(0,t.mdx)("mo",{parentName:"mrow"},"\u2061"),(0,t.mdx)("mo",{parentName:"mrow",stretchy:"false"},"["),(0,t.mdx)("mi",{parentName:"mrow"},"g"),(0,t.mdx)("mo",{parentName:"mrow",stretchy:"false"},"("),(0,t.mdx)("msup",{parentName:"mrow"},(0,t.mdx)("mi",{parentName:"msup"},"x"),(0,t.mdx)("mo",{parentName:"msup",mathvariant:"normal",lspace:"0em",rspace:"0em"},"\u2032")),(0,t.mdx)("mo",{parentName:"mrow"},"\u2223"),(0,t.mdx)("mi",{parentName:"mrow"},"x"),(0,t.mdx)("mo",{parentName:"mrow",stretchy:"false"},")"),(0,t.mdx)("mo",{parentName:"mrow",stretchy:"false"},"]")),(0,t.mdx)("annotation",{parentName:"semantics",encoding:"application/x-tex"},"\\log[g(x' \\mid x)]")))),(0,t.mdx)("span",{parentName:"span",className:"katex-html","aria-hidden":"true"},(0,t.mdx)("span",{parentName:"span",className:"base"},(0,t.mdx)("span",{parentName:"span",className:"strut",style:{height:"1.001892em",verticalAlign:"-0.25em"}}),(0,t.mdx)("span",{parentName:"span",className:"mop"},"lo",(0,t.mdx)("span",{parentName:"span",style:{marginRight:"0.01389em"}},"g")),(0,t.mdx)("span",{parentName:"span",className:"mopen"},"["),(0,t.mdx)("span",{parentName:"span",className:"mord mathnormal",style:{marginRight:"0.03588em"}},"g"),(0,t.mdx)("span",{parentName:"span",className:"mopen"},"("),(0,t.mdx)("span",{parentName:"span",className:"mord"},(0,t.mdx)("span",{parentName:"span",className:"mord mathnormal"},"x"),(0,t.mdx)("span",{parentName:"span",className:"msupsub"},(0,t.mdx)("span",{parentName:"span",className:"vlist-t"},(0,t.mdx)("span",{parentName:"span",className:"vlist-r"},(0,t.mdx)("span",{parentName:"span",className:"vlist",style:{height:"0.751892em"}},(0,t.mdx)("span",{parentName:"span",style:{top:"-3.063em",marginRight:"0.05em"}},(0,t.mdx)("span",{parentName:"span",className:"pstrut",style:{height:"2.7em"}}),(0,t.mdx)("span",{parentName:"span",className:"sizing reset-size6 size3 mtight"},(0,t.mdx)("span",{parentName:"span",className:"mord mtight"},(0,t.mdx)("span",{parentName:"span",className:"mord mtight"},"\u2032"))))))))),(0,t.mdx)("span",{parentName:"span",className:"mspace",style:{marginRight:"0.2777777777777778em"}}),(0,t.mdx)("span",{parentName:"span",className:"mrel"},"\u2223"),(0,t.mdx)("span",{parentName:"span",className:"mspace",style:{marginRight:"0.2777777777777778em"}})),(0,t.mdx)("span",{parentName:"span",className:"base"},(0,t.mdx)("span",{parentName:"span",className:"strut",style:{height:"1em",verticalAlign:"-0.25em"}}),(0,t.mdx)("span",{parentName:"span",className:"mord mathnormal"},"x"),(0,t.mdx)("span",{parentName:"span",className:"mclose"},")"),(0,t.mdx)("span",{parentName:"span",className:"mclose"},"]"))))),", the log probability of proposing this value"),(0,t.mdx)("li",{parentName:"ul"},"a dictionary of the auxiliary variables used in propose that are needed by ",(0,t.mdx)("inlineCode",{parentName:"li"},"post_process"))),(0,t.mdx)("h4",{id:"post-process"},"Post Process"),(0,t.mdx)("p",null,(0,t.mdx)("inlineCode",{parentName:"p"},"post_process")," take three parameters: the node, the world, and the auxiliary variables dictionary."),(0,t.mdx)("ul",null,(0,t.mdx)("li",{parentName:"ul"},"node: (same as ",(0,t.mdx)("inlineCode",{parentName:"li"},"propose"),") ",(0,t.mdx)("span",{parentName:"li",className:"math math-inline"},(0,t.mdx)("span",{parentName:"span",className:"katex"},(0,t.mdx)("span",{parentName:"span",className:"katex-mathml"},(0,t.mdx)("math",{parentName:"span",xmlns:"http://www.w3.org/1998/Math/MathML"},(0,t.mdx)("semantics",{parentName:"math"},(0,t.mdx)("mrow",{parentName:"semantics"},(0,t.mdx)("mi",{parentName:"mrow"},"X")),(0,t.mdx)("annotation",{parentName:"semantics",encoding:"application/x-tex"},"X")))),(0,t.mdx)("span",{parentName:"span",className:"katex-html","aria-hidden":"true"},(0,t.mdx)("span",{parentName:"span",className:"base"},(0,t.mdx)("span",{parentName:"span",className:"strut",style:{height:"0.68333em",verticalAlign:"0em"}}),(0,t.mdx)("span",{parentName:"span",className:"mord mathnormal",style:{marginRight:"0.07847em"}},"X"))))),", the random variable to propose a new value for"),(0,t.mdx)("li",{parentName:"ul"},"world: (same as ",(0,t.mdx)("inlineCode",{parentName:"li"},"propose"),", but ",(0,t.mdx)("em",{parentName:"li"},"updated with the proposed")," value for node) graphical data structure representing variable dependencies and values in the model"),(0,t.mdx)("li",{parentName:"ul"},"auxiliary variables: the same dictionary returned by ",(0,t.mdx)("inlineCode",{parentName:"li"},"propose"))),(0,t.mdx)("p",null,"The return value of ",(0,t.mdx)("inlineCode",{parentName:"p"},"post_process")," is ",(0,t.mdx)("span",{parentName:"p",className:"math math-inline"},(0,t.mdx)("span",{parentName:"span",className:"katex"},(0,t.mdx)("span",{parentName:"span",className:"katex-mathml"},(0,t.mdx)("math",{parentName:"span",xmlns:"http://www.w3.org/1998/Math/MathML"},(0,t.mdx)("semantics",{parentName:"math"},(0,t.mdx)("mrow",{parentName:"semantics"},(0,t.mdx)("mi",{parentName:"mrow"},"log"),(0,t.mdx)("mo",{parentName:"mrow"},"\u2061"),(0,t.mdx)("mo",{parentName:"mrow",stretchy:"false"},"["),(0,t.mdx)("mi",{parentName:"mrow"},"g"),(0,t.mdx)("mo",{parentName:"mrow",stretchy:"false"},"("),(0,t.mdx)("mi",{parentName:"mrow"},"x"),(0,t.mdx)("mo",{parentName:"mrow"},"\u2223"),(0,t.mdx)("msup",{parentName:"mrow"},(0,t.mdx)("mi",{parentName:"msup"},"x"),(0,t.mdx)("mo",{parentName:"msup",mathvariant:"normal",lspace:"0em",rspace:"0em"},"\u2032")),(0,t.mdx)("mo",{parentName:"mrow",stretchy:"false"},")"),(0,t.mdx)("mo",{parentName:"mrow",stretchy:"false"},"]")),(0,t.mdx)("annotation",{parentName:"semantics",encoding:"application/x-tex"},"\\log[g(x \\mid x')]")))),(0,t.mdx)("span",{parentName:"span",className:"katex-html","aria-hidden":"true"},(0,t.mdx)("span",{parentName:"span",className:"base"},(0,t.mdx)("span",{parentName:"span",className:"strut",style:{height:"1em",verticalAlign:"-0.25em"}}),(0,t.mdx)("span",{parentName:"span",className:"mop"},"lo",(0,t.mdx)("span",{parentName:"span",style:{marginRight:"0.01389em"}},"g")),(0,t.mdx)("span",{parentName:"span",className:"mopen"},"["),(0,t.mdx)("span",{parentName:"span",className:"mord mathnormal",style:{marginRight:"0.03588em"}},"g"),(0,t.mdx)("span",{parentName:"span",className:"mopen"},"("),(0,t.mdx)("span",{parentName:"span",className:"mord mathnormal"},"x"),(0,t.mdx)("span",{parentName:"span",className:"mspace",style:{marginRight:"0.2777777777777778em"}}),(0,t.mdx)("span",{parentName:"span",className:"mrel"},"\u2223"),(0,t.mdx)("span",{parentName:"span",className:"mspace",style:{marginRight:"0.2777777777777778em"}})),(0,t.mdx)("span",{parentName:"span",className:"base"},(0,t.mdx)("span",{parentName:"span",className:"strut",style:{height:"1.001892em",verticalAlign:"-0.25em"}}),(0,t.mdx)("span",{parentName:"span",className:"mord"},(0,t.mdx)("span",{parentName:"span",className:"mord mathnormal"},"x"),(0,t.mdx)("span",{parentName:"span",className:"msupsub"},(0,t.mdx)("span",{parentName:"span",className:"vlist-t"},(0,t.mdx)("span",{parentName:"span",className:"vlist-r"},(0,t.mdx)("span",{parentName:"span",className:"vlist",style:{height:"0.751892em"}},(0,t.mdx)("span",{parentName:"span",style:{top:"-3.063em",marginRight:"0.05em"}},(0,t.mdx)("span",{parentName:"span",className:"pstrut",style:{height:"2.7em"}}),(0,t.mdx)("span",{parentName:"span",className:"sizing reset-size6 size3 mtight"},(0,t.mdx)("span",{parentName:"span",className:"mord mtight"},(0,t.mdx)("span",{parentName:"span",className:"mord mtight"},"\u2032"))))))))),(0,t.mdx)("span",{parentName:"span",className:"mclose"},")"),(0,t.mdx)("span",{parentName:"span",className:"mclose"},"]"))))),", the log probability of proposing the original value given the new value."),(0,t.mdx)("h3",{id:"important-methods"},"Important Methods"),(0,t.mdx)("p",null,"The ",(0,t.mdx)("inlineCode",{parentName:"p"},"node")," is of type ",(0,t.mdx)("inlineCode",{parentName:"p"},"RVIdentifier"),", which includes only the function and its parameters. To access the ",(0,t.mdx)("inlineCode",{parentName:"p"},"Variable")," corresponding to this node in the world, call"),(0,t.mdx)("pre",null,(0,t.mdx)("code",{parentName:"pre",className:"language-py"},"world.get_node_in_world_raise_error(node, False)\n")),(0,t.mdx)("p",null,"This returns the associated ",(0,t.mdx)("inlineCode",{parentName:"p"},"Variable")," (see Variable API documentation for more details)."),(0,t.mdx)("h3",{id:"sample-custom-proposer"},"Sample Custom Proposer"),(0,t.mdx)("p",null,"Here, we implement a custom proposer for locating seismic events on Earth as described in ","[1]",". In particular, the simplified version of the model is used, where one seismic event, denoted in the model by ",(0,t.mdx)("inlineCode",{parentName:"p"},"event_attr()"),", occurs randomly on the surface of the Earth. This event sends seismic energy in a single wave. There are different seismic stations across the surface of the Earth, and each station will noisily record its attributes of time, azimuth, and slowness, denoted by ",(0,t.mdx)("inlineCode",{parentName:"p"},"det_attr(s)"),". The inference problem is to find the ",(0,t.mdx)("inlineCode",{parentName:"p"},"event_attr()")," given the ",(0,t.mdx)("inlineCode",{parentName:"p"},"det_attr(s)"),"."),(0,t.mdx)("pre",null,(0,t.mdx)("code",{parentName:"pre",className:"language-py"},"@bm.random_variable\ndef event_attr():\n  return SeismicEventPrior()\n\n@bm.random_variable\ndef det_attr(station):\n    det_loc = calculate_detection(station, event_attr())\n    return Laplace(det_loc, scale)\n")),(0,t.mdx)("p",null,"There is domain knowledge within seismology to mathematically solve for the most likely attributes of an event given the detection attributes for a specific station. Due to the noisy nature of the data, these predicted locations can be inaccurate, but this can be mitigated by considering the detections in many stations."),(0,t.mdx)("p",null,"An ideal MH proposer for location values would propose locations according to the exact posterior probability of the location given all stations, but computing this posterior or sampling from it is intractable. A simpler but still effective proposer independently computes one predicted location per individual station, which is an easier problem, and then selects, according to a Gaussian mixture model, one of these predicted locations for being proposed. This is effective because, with enough stations, it is likely that one of the predictions will be close to the true location."),(0,t.mdx)("p",null,"With this intuition, we use Bean Machine\u2019s easily implementable proposer interface to write a custom proposer for the ",(0,t.mdx)("inlineCode",{parentName:"p"},"event_attr")," variable, which inspects the ",(0,t.mdx)("inlineCode",{parentName:"p"},"det_attr(s)")," children variables and uses a Gaussian mixture model proposer around the predicted attributes for each of the detections:"),(0,t.mdx)("pre",null,(0,t.mdx)("code",{parentName:"pre",className:"language-py"},"class SingleSiteSeismicProposer(AbstractSingleSiteProposer):\n\n    def value(self, child: RVIdentifier) -> Tensor:\n        return world.get_node_in_world_raise_error(child, False).value\n\n    def proposal_distribution_of_event_given_children_det_attr(event_node):\n        # instead of computing the probability of the event given\n        # the join detections (a computation exponential in the number of detections),\n        # we compute the probability of the event\n        # given each separate detection and propose to use one of them\n        # by sampling from a Gaussian mixture model.\n        event_var = world.get_node_in_world_raise_error(node, False)\n        inverse_distributions_of_event_given_det_attrs =\n            [inverted_laplace(self.value(child_det_attr))\n            for child_det_attr in event_var.children]\n        return create_gaussian_mixture_model(inverse_distributions_of_event_given_det_attrs)\n\n    def propose(self, event_node: RVIdentifier, world: World) -> Tuple[Tensor, Tensor, Dict]:\n        proposal_distribution = proposal_distribution_of_event_given_children_det_attr(event_node)\n        new_value = proposal_distribution.sample()\n        log_prob = proposal_distribution.log_prob(new_value)\n        return new_value, log_prob, {}\n\n    def post_process(self, event_node: RVIdentifier, world: World, aux_variables: Dict) -> Tensor:\n        proposal_distribution = proposal_distribution_of_event_given_children_det_attr(event_node)\n        old_value = world.get_old_value(event_node)\n        return proposal_distribution.log_prob(old_value)\n")),(0,t.mdx)("p",null,"Note that the particular above proposer proposes a new value based solely on the values of the ",(0,t.mdx)("em",{parentName:"p"},"children")," of ",(0,t.mdx)("inlineCode",{parentName:"p"},"node"),", and does not use the ",(0,t.mdx)("em",{parentName:"p"},"value")," of node.\nTherefore the value ",(0,t.mdx)("span",{parentName:"p",className:"math math-inline"},(0,t.mdx)("span",{parentName:"span",className:"katex"},(0,t.mdx)("span",{parentName:"span",className:"katex-mathml"},(0,t.mdx)("math",{parentName:"span",xmlns:"http://www.w3.org/1998/Math/MathML"},(0,t.mdx)("semantics",{parentName:"math"},(0,t.mdx)("mrow",{parentName:"semantics"},(0,t.mdx)("mi",{parentName:"mrow"},"log"),(0,t.mdx)("mo",{parentName:"mrow"},"\u2061"),(0,t.mdx)("mo",{parentName:"mrow",stretchy:"false"},"["),(0,t.mdx)("mi",{parentName:"mrow"},"g"),(0,t.mdx)("mo",{parentName:"mrow",stretchy:"false"},"("),(0,t.mdx)("msup",{parentName:"mrow"},(0,t.mdx)("mi",{parentName:"msup"},"x"),(0,t.mdx)("mo",{parentName:"msup",mathvariant:"normal",lspace:"0em",rspace:"0em"},"\u2032")),(0,t.mdx)("mo",{parentName:"mrow"},"\u2223"),(0,t.mdx)("mi",{parentName:"mrow"},"x"),(0,t.mdx)("mo",{parentName:"mrow",stretchy:"false"},")"),(0,t.mdx)("mo",{parentName:"mrow",stretchy:"false"},"]")),(0,t.mdx)("annotation",{parentName:"semantics",encoding:"application/x-tex"},"\\log[g(x' \\mid x)]")))),(0,t.mdx)("span",{parentName:"span",className:"katex-html","aria-hidden":"true"},(0,t.mdx)("span",{parentName:"span",className:"base"},(0,t.mdx)("span",{parentName:"span",className:"strut",style:{height:"1.001892em",verticalAlign:"-0.25em"}}),(0,t.mdx)("span",{parentName:"span",className:"mop"},"lo",(0,t.mdx)("span",{parentName:"span",style:{marginRight:"0.01389em"}},"g")),(0,t.mdx)("span",{parentName:"span",className:"mopen"},"["),(0,t.mdx)("span",{parentName:"span",className:"mord mathnormal",style:{marginRight:"0.03588em"}},"g"),(0,t.mdx)("span",{parentName:"span",className:"mopen"},"("),(0,t.mdx)("span",{parentName:"span",className:"mord"},(0,t.mdx)("span",{parentName:"span",className:"mord mathnormal"},"x"),(0,t.mdx)("span",{parentName:"span",className:"msupsub"},(0,t.mdx)("span",{parentName:"span",className:"vlist-t"},(0,t.mdx)("span",{parentName:"span",className:"vlist-r"},(0,t.mdx)("span",{parentName:"span",className:"vlist",style:{height:"0.751892em"}},(0,t.mdx)("span",{parentName:"span",style:{top:"-3.063em",marginRight:"0.05em"}},(0,t.mdx)("span",{parentName:"span",className:"pstrut",style:{height:"2.7em"}}),(0,t.mdx)("span",{parentName:"span",className:"sizing reset-size6 size3 mtight"},(0,t.mdx)("span",{parentName:"span",className:"mord mtight"},(0,t.mdx)("span",{parentName:"span",className:"mord mtight"},"\u2032"))))))))),(0,t.mdx)("span",{parentName:"span",className:"mspace",style:{marginRight:"0.2777777777777778em"}}),(0,t.mdx)("span",{parentName:"span",className:"mrel"},"\u2223"),(0,t.mdx)("span",{parentName:"span",className:"mspace",style:{marginRight:"0.2777777777777778em"}})),(0,t.mdx)("span",{parentName:"span",className:"base"},(0,t.mdx)("span",{parentName:"span",className:"strut",style:{height:"1em",verticalAlign:"-0.25em"}}),(0,t.mdx)("span",{parentName:"span",className:"mord mathnormal"},"x"),(0,t.mdx)("span",{parentName:"span",className:"mclose"},")"),(0,t.mdx)("span",{parentName:"span",className:"mclose"},"]")))))," returned by ",(0,t.mdx)("inlineCode",{parentName:"p"},"propose")," is independent of the actual value ",(0,t.mdx)("span",{parentName:"p",className:"math math-inline"},(0,t.mdx)("span",{parentName:"span",className:"katex"},(0,t.mdx)("span",{parentName:"span",className:"katex-mathml"},(0,t.mdx)("math",{parentName:"span",xmlns:"http://www.w3.org/1998/Math/MathML"},(0,t.mdx)("semantics",{parentName:"math"},(0,t.mdx)("mrow",{parentName:"semantics"},(0,t.mdx)("mi",{parentName:"mrow"},"x")),(0,t.mdx)("annotation",{parentName:"semantics",encoding:"application/x-tex"},"x")))),(0,t.mdx)("span",{parentName:"span",className:"katex-html","aria-hidden":"true"},(0,t.mdx)("span",{parentName:"span",className:"base"},(0,t.mdx)("span",{parentName:"span",className:"strut",style:{height:"0.43056em",verticalAlign:"0em"}}),(0,t.mdx)("span",{parentName:"span",className:"mord mathnormal"},"x"))))),".\nLikewise, the value ",(0,t.mdx)("span",{parentName:"p",className:"math math-inline"},(0,t.mdx)("span",{parentName:"span",className:"katex"},(0,t.mdx)("span",{parentName:"span",className:"katex-mathml"},(0,t.mdx)("math",{parentName:"span",xmlns:"http://www.w3.org/1998/Math/MathML"},(0,t.mdx)("semantics",{parentName:"math"},(0,t.mdx)("mrow",{parentName:"semantics"},(0,t.mdx)("mi",{parentName:"mrow"},"log"),(0,t.mdx)("mo",{parentName:"mrow"},"\u2061"),(0,t.mdx)("mo",{parentName:"mrow",stretchy:"false"},"["),(0,t.mdx)("mi",{parentName:"mrow"},"g"),(0,t.mdx)("mo",{parentName:"mrow",stretchy:"false"},"("),(0,t.mdx)("mi",{parentName:"mrow"},"x"),(0,t.mdx)("mo",{parentName:"mrow"},"\u2223"),(0,t.mdx)("msup",{parentName:"mrow"},(0,t.mdx)("mi",{parentName:"msup"},"x"),(0,t.mdx)("mo",{parentName:"msup",mathvariant:"normal",lspace:"0em",rspace:"0em"},"\u2032")),(0,t.mdx)("mo",{parentName:"mrow",stretchy:"false"},")"),(0,t.mdx)("mo",{parentName:"mrow",stretchy:"false"},"]")),(0,t.mdx)("annotation",{parentName:"semantics",encoding:"application/x-tex"},"\\log[g(x \\mid x')]")))),(0,t.mdx)("span",{parentName:"span",className:"katex-html","aria-hidden":"true"},(0,t.mdx)("span",{parentName:"span",className:"base"},(0,t.mdx)("span",{parentName:"span",className:"strut",style:{height:"1em",verticalAlign:"-0.25em"}}),(0,t.mdx)("span",{parentName:"span",className:"mop"},"lo",(0,t.mdx)("span",{parentName:"span",style:{marginRight:"0.01389em"}},"g")),(0,t.mdx)("span",{parentName:"span",className:"mopen"},"["),(0,t.mdx)("span",{parentName:"span",className:"mord mathnormal",style:{marginRight:"0.03588em"}},"g"),(0,t.mdx)("span",{parentName:"span",className:"mopen"},"("),(0,t.mdx)("span",{parentName:"span",className:"mord mathnormal"},"x"),(0,t.mdx)("span",{parentName:"span",className:"mspace",style:{marginRight:"0.2777777777777778em"}}),(0,t.mdx)("span",{parentName:"span",className:"mrel"},"\u2223"),(0,t.mdx)("span",{parentName:"span",className:"mspace",style:{marginRight:"0.2777777777777778em"}})),(0,t.mdx)("span",{parentName:"span",className:"base"},(0,t.mdx)("span",{parentName:"span",className:"strut",style:{height:"1.001892em",verticalAlign:"-0.25em"}}),(0,t.mdx)("span",{parentName:"span",className:"mord"},(0,t.mdx)("span",{parentName:"span",className:"mord mathnormal"},"x"),(0,t.mdx)("span",{parentName:"span",className:"msupsub"},(0,t.mdx)("span",{parentName:"span",className:"vlist-t"},(0,t.mdx)("span",{parentName:"span",className:"vlist-r"},(0,t.mdx)("span",{parentName:"span",className:"vlist",style:{height:"0.751892em"}},(0,t.mdx)("span",{parentName:"span",style:{top:"-3.063em",marginRight:"0.05em"}},(0,t.mdx)("span",{parentName:"span",className:"pstrut",style:{height:"2.7em"}}),(0,t.mdx)("span",{parentName:"span",className:"sizing reset-size6 size3 mtight"},(0,t.mdx)("span",{parentName:"span",className:"mord mtight"},(0,t.mdx)("span",{parentName:"span",className:"mord mtight"},"\u2032"))))))))),(0,t.mdx)("span",{parentName:"span",className:"mclose"},")"),(0,t.mdx)("span",{parentName:"span",className:"mclose"},"]")))))," returned by ",(0,t.mdx)("inlineCode",{parentName:"p"},"post_process")," does not use the new value ",(0,t.mdx)("span",{parentName:"p",className:"math math-inline"},(0,t.mdx)("span",{parentName:"span",className:"katex"},(0,t.mdx)("span",{parentName:"span",className:"katex-mathml"},(0,t.mdx)("math",{parentName:"span",xmlns:"http://www.w3.org/1998/Math/MathML"},(0,t.mdx)("semantics",{parentName:"math"},(0,t.mdx)("mrow",{parentName:"semantics"},(0,t.mdx)("msup",{parentName:"mrow"},(0,t.mdx)("mi",{parentName:"msup"},"x"),(0,t.mdx)("mo",{parentName:"msup",mathvariant:"normal",lspace:"0em",rspace:"0em"},"\u2032"))),(0,t.mdx)("annotation",{parentName:"semantics",encoding:"application/x-tex"},"x'")))),(0,t.mdx)("span",{parentName:"span",className:"katex-html","aria-hidden":"true"},(0,t.mdx)("span",{parentName:"span",className:"base"},(0,t.mdx)("span",{parentName:"span",className:"strut",style:{height:"0.751892em",verticalAlign:"0em"}}),(0,t.mdx)("span",{parentName:"span",className:"mord"},(0,t.mdx)("span",{parentName:"span",className:"mord mathnormal"},"x"),(0,t.mdx)("span",{parentName:"span",className:"msupsub"},(0,t.mdx)("span",{parentName:"span",className:"vlist-t"},(0,t.mdx)("span",{parentName:"span",className:"vlist-r"},(0,t.mdx)("span",{parentName:"span",className:"vlist",style:{height:"0.751892em"}},(0,t.mdx)("span",{parentName:"span",style:{top:"-3.063em",marginRight:"0.05em"}},(0,t.mdx)("span",{parentName:"span",className:"pstrut",style:{height:"2.7em"}}),(0,t.mdx)("span",{parentName:"span",className:"sizing reset-size6 size3 mtight"},(0,t.mdx)("span",{parentName:"span",className:"mord mtight"},(0,t.mdx)("span",{parentName:"span",className:"mord mtight"},"\u2032"))))))))))))),"."),(0,t.mdx)("p",null,"Because the proposal distribution is the same in both ",(0,t.mdx)("inlineCode",{parentName:"p"},"propose")," and ",(0,t.mdx)("inlineCode",{parentName:"p"},"post_process")," (since it only depends on the children variable which are not modified),\nan important optimization in this sampler could be to add ",(0,t.mdx)("inlineCode",{parentName:"p"},"proposal_distribution")," in the auxiliary variables\nreturned by ",(0,t.mdx)("inlineCode",{parentName:"p"},"propose")," and reuse it in ",(0,t.mdx)("inlineCode",{parentName:"p"},"post_process"),"."),(0,t.mdx)("p",null,"Also note that in ",(0,t.mdx)("inlineCode",{parentName:"p"},"post_process")," we must evaluate the proposal distribution on ",(0,t.mdx)("span",{parentName:"p",className:"math math-inline"},(0,t.mdx)("span",{parentName:"span",className:"katex"},(0,t.mdx)("span",{parentName:"span",className:"katex-mathml"},(0,t.mdx)("math",{parentName:"span",xmlns:"http://www.w3.org/1998/Math/MathML"},(0,t.mdx)("semantics",{parentName:"math"},(0,t.mdx)("mrow",{parentName:"semantics"},(0,t.mdx)("mi",{parentName:"mrow"},"x")),(0,t.mdx)("annotation",{parentName:"semantics",encoding:"application/x-tex"},"x")))),(0,t.mdx)("span",{parentName:"span",className:"katex-html","aria-hidden":"true"},(0,t.mdx)("span",{parentName:"span",className:"base"},(0,t.mdx)("span",{parentName:"span",className:"strut",style:{height:"0.43056em",verticalAlign:"0em"}}),(0,t.mdx)("span",{parentName:"span",className:"mord mathnormal"},"x"))))),", which is no longer available from ",(0,t.mdx)("inlineCode",{parentName:"p"},"event_node.value"),"\nbecause now the world has been updated with the new value ",(0,t.mdx)("span",{parentName:"p",className:"math math-inline"},(0,t.mdx)("span",{parentName:"span",className:"katex"},(0,t.mdx)("span",{parentName:"span",className:"katex-mathml"},(0,t.mdx)("math",{parentName:"span",xmlns:"http://www.w3.org/1998/Math/MathML"},(0,t.mdx)("semantics",{parentName:"math"},(0,t.mdx)("mrow",{parentName:"semantics"},(0,t.mdx)("msup",{parentName:"mrow"},(0,t.mdx)("mi",{parentName:"msup"},"x"),(0,t.mdx)("mo",{parentName:"msup",mathvariant:"normal",lspace:"0em",rspace:"0em"},"\u2032"))),(0,t.mdx)("annotation",{parentName:"semantics",encoding:"application/x-tex"},"x'")))),(0,t.mdx)("span",{parentName:"span",className:"katex-html","aria-hidden":"true"},(0,t.mdx)("span",{parentName:"span",className:"base"},(0,t.mdx)("span",{parentName:"span",className:"strut",style:{height:"0.751892em",verticalAlign:"0em"}}),(0,t.mdx)("span",{parentName:"span",className:"mord"},(0,t.mdx)("span",{parentName:"span",className:"mord mathnormal"},"x"),(0,t.mdx)("span",{parentName:"span",className:"msupsub"},(0,t.mdx)("span",{parentName:"span",className:"vlist-t"},(0,t.mdx)("span",{parentName:"span",className:"vlist-r"},(0,t.mdx)("span",{parentName:"span",className:"vlist",style:{height:"0.751892em"}},(0,t.mdx)("span",{parentName:"span",style:{top:"-3.063em",marginRight:"0.05em"}},(0,t.mdx)("span",{parentName:"span",className:"pstrut",style:{height:"2.7em"}}),(0,t.mdx)("span",{parentName:"span",className:"sizing reset-size6 size3 mtight"},(0,t.mdx)("span",{parentName:"span",className:"mord mtight"},(0,t.mdx)("span",{parentName:"span",className:"mord mtight"},"\u2032"))))))))))))),".\nHowever the old value is still available from ",(0,t.mdx)("inlineCode",{parentName:"p"},"world.get_old_value(node)")," (or ",(0,t.mdx)("inlineCode",{parentName:"p"},"world.get_old_transformed_value(node)")," if a transform is being used)."),(0,t.mdx)("h3",{id:"gradient-based-proposers"},"Gradient-based proposers"),(0,t.mdx)("p",null,"The ",(0,t.mdx)("inlineCode",{parentName:"p"},"World")," class also provides support for gradient-based proposers (see World and Variable API documentation for more details). For all continuous variables, the gradient is tracked for ",(0,t.mdx)("inlineCode",{parentName:"p"},"transformed_value"),". Because of the locally-structured nature of Bean Machine models, the contribution of a variable to a world's likelihood is determined solely from the values of the variable itself and its child nodes (those nodes whose distributions are directly influenced by the value of the variable). The likelihood of the relevant parts of the world, also known as the score, can be computed using"),(0,t.mdx)("pre",null,(0,t.mdx)("code",{parentName:"pre",className:"language-py"},"compute_score(node_var: Variable) -> Tensor\n")),(0,t.mdx)("p",null,"To calculate the gradient of a variable in the ",(0,t.mdx)("inlineCode",{parentName:"p"},"propose")," method, we first need to access the ",(0,t.mdx)("inlineCode",{parentName:"p"},"Variable")," object corresponding to the ",(0,t.mdx)("inlineCode",{parentName:"p"},"RVIdentifier")," node. We then compute the score of node, and then take the gradient with respect to the ",(0,t.mdx)("inlineCode",{parentName:"p"},"transformed_value")," using the ",(0,t.mdx)("inlineCode",{parentName:"p"},"grad")," implementation supported by PyTorch."),(0,t.mdx)("pre",null,(0,t.mdx)("code",{parentName:"pre",className:"language-py"},"node_var = world.get_node_in_world(node, False)\nscore = world.compute_score(node_var)\nfirst_gradient = grad(score, node_val)\n")),(0,t.mdx)("p",null,"The gradient can now be used to obtain a new proposal for the variable."),(0,t.mdx)("p",null,"[1]"," Arora, Nimar & Russell, Stuart & Sudderth, Erik. (2013). NET-VISA: Network Processing Vertically Integrated Seismic Analysis. The Bulletin of the Seismological Society of America. 103. 709-729. 10.1785/0120120107."))}N.isMDXComponent=!0}}]);